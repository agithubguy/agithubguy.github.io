<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="murasaki's center  with enhanced features and performance">
    <title>murasaki's center v3 | enhanced experience</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rubik:wght@400;700&display=swap" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js" as="script">
    

    <!-- Inline critical CSS -->
    <style>
        /* Critical CSS - minimal styles needed for initial render */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0d1b2a;
            color: #e0e1dd;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            font-family: 'Rubik', sans-serif;
             transition: 
        background-color 0.3s ease,
        color 0.3s ease;
        }

  .media-upload-btn {
                padding: 8px 12px;
                background: rgba(0, 168, 255, 0.1);
                border-radius: 5px;
                cursor: pointer;
                color: var(--primary);
                border: 1px dashed var(--primary);
                transition: all 0.2s ease;
            }
            
            .media-upload-btn:hover {
                background: rgba(0, 168, 255, 0.2);
                transform: scale(1.05);
            }
.logout-btn {
    width: 100%;
    padding: 10px;
    background: rgba(255, 45, 117, 0.2);
    color: #ff2d75;
    border: 1px solid #ff2d75;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
}

.logout-btn:hover {
    background: rgba(255, 45, 117, 0.3);
}

body.dark-mode .logout-btn {
    background: rgba(255, 45, 117, 0.1);
    color: #ff6b8b;
    border-color: #ff6b8b;
}

body.dark-mode .logout-btn:hover {
    background: rgba(255, 45, 117, 0.2);
}
auth-btn.loading {
    opacity: 0.7;
    pointer-events: none;
}

.auth-btn.loading::after {
    content: '...';
    animation: loadingDots 1.5s infinite;
}

@keyframes loadingDots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}
/* Confirmation modal styles */
.logout-confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 3000;
}

.logout-confirm-content {
    background: #0d1b2a;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    border: 1px solid #ff2d75;
}

.logout-confirm-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.confirm-btn, .cancel-btn {
    padding: 8px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}

.confirm-btn {
    background: #ff2d75;
    color: white;
    border: none;
}

.cancel-btn {
    background: transparent;
    color: #00a8ff;
    border: 1px solid #00a8ff;
}
/* UI Components */
.game-card,
.tab,
.message,
.settings-content,
.chat-container,
.ai-container {
    transition: 
        background-color 0.3s ease,
        border-color 0.3s ease,
        box-shadow 0.3s ease;
}
/* Text elements */
h1, h2, h3, h4, h5, h6,
p, span, a, li {
    transition: color 0.3s ease;
}
#fps-counter {
    position: fixed;
    top: 10px;
    left: 10px;
    padding: 5px 10px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 3px;
    color: white;
    font-family: monospace;
    font-size: 14px;
    z-index: 9999;
}

body.dark-mode #fps-counter {
    background: rgba(0, 0, 0, 0.7);
    color: #e0e1dd;
}

/* Remove the old FPS display styles */
/* Inputs and buttons */
input,
textarea,
button,
select {
    transition: 
        background-color 0.3s ease,
        color 0.3s ease,
        border-color 0.3s ease;
}
        .auth-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .main-container {
            display: none;
            flex: 1;
            flex-direction: column;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        .hidden {
            display: none;
        }


/* Ultra Dark Blue Dark Mode */
body.dark-mode {
    background: #090933 !important;  /* Near-black blue */
}

/* Game Cards */
body.dark-mode .game-card {
    background: rgba(15, 16, 70, 0.9); /* Slightly transparent */
    border: 1px solid #242679; /* Slightly lighter blue border */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Text Elements */
body.dark-mode .title {
    background: linear-gradient(90deg, #4a54ff, #7b83ff);
    -webkit-background-clip: text;
    background-clip: text;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
}

body.dark-mode h1, h2, h3, h4 {
    color: #d6dcff;
}

/* Buttons */
body.dark-mode .play-btn {
    background: linear-gradient(90deg, #3032a8, #242679);
    color: white;
    border: none;
}

/* Tabs */
body.dark-mode .tab {
    background: rgba(15, 16, 70, 0.7);
    color: #d6dcff;
    border: 1px solid #3032a8;
}

body.dark-mode .tab:hover,
body.dark-mode .tab.active {
    background: rgba(48, 50, 168, 0.4);
    border-color: #4a54ff;
}

/* Special Adjustments */
body.dark-mode .bg-animation {
    background: linear-gradient(135deg, 
        #090933 0%, 
        #0a0a35 25%, 
        #0b0b3b 50%, 
        #0c0c3f 75%, 
        #0c0c43 100%) !important;
}

body.dark-mode .particles-js-canvas-el {
    opacity: 0.3 !important;
}

/* Input Fields */
body.dark-mode input,
body.dark-mode textarea {
    background: rgba(15, 16, 70, 0.6);
    color: #f0f4ff;
    border: 1px solid #3032a8;
}

/* Ensure contrast for all text */
body.dark-mode p, 
body.dark-mode .game-info p {
    color: #c2c8ff;
}
/* Toggle switch styles */
.toggle-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
#ai-clear-btn {
    background: rgba(255, 45, 117, 0.2);
    border: 1px solid #ff2d75;
    color: #ff2d75;
}

#ai-clear-btn:hover {
    background: rgba(255, 45, 117, 0.3);
}
input:checked + .slider {
    background: linear-gradient(90deg, #00a8ff, #ff2d75);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.setting-description {
    font-size: 0.8rem;
    color: rgba(224, 225, 221, 0.7);
    margin-top: 5px;
}
        /* Add to your CSS */
.cloak-toggle-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    padding: 8px 12px;
    background: linear-gradient(90deg, #00a8ff, #ff2d75);
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    opacity: 0.3;
    transition: opacity 0.3s;
}

.cloak-toggle-btn:hover {
    opacity: 1;
}
        /* Animation keyframes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
        
        @keyframes windowsFade {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Settings Modal Styles (Critical) */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: #0d1b2a;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            border-radius: 15px;
            border: 2px solid #00a8ff;
            padding: 20px;
            overflow-y: auto;
            animation: windowsFade 0.3s ease-out;
        }

        .settings-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #e0e1dd;
            font-size: 1.5rem;
            cursor: pointer;
        }
.settings-content::-webkit-scrollbar {
    width: 8px;
}

.settings-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
}

.settings-content::-webkit-scrollbar-thumb {
    background: rgba(0, 168, 255, 0.5);
    border-radius: 10px;
}

.settings-content::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 168, 255, 0.7);
}

.settings-option select {
    background: rgba(224, 225, 221, 0.1);
    color: #e0e1dd;
    border: 1px solid rgba(0, 168, 255, 0.3);
    padding: 8px;
    border-radius: 5px;
    width: 100%;
    margin-bottom: 10px;
}

.settings-option select:focus {
    outline: none;
    border-color: #00a8ff;
    box-shadow: 0 0 5px rgba(0, 168, 255, 0.5);
}
        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 168, 255, 0.3);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h3 {
            color: #00a8ff;
            margin-bottom: 15px;
        }

        .settings-section h4 {
            color: #e0e1dd;
            margin: 15px 0 10px;
            font-size: 1rem;
        }

        .settings-option {
            margin-bottom: 15px;
        }

        .settings-option label {
            display: flex;
            align-items: center;
            color: #e0e1dd;
            cursor: pointer;
        }

        .settings-option input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .color-picker-container input[type="color"] {
            width: 50px;
            height: 30px;
            border: 1px solid #00a8ff;
            border-radius: 5px;
            cursor: pointer;
        }

        .color-picker-container button {
            padding: 5px 10px;
            background: rgba(0, 168, 255, 0.2);
            border: 1px solid #00a8ff;
            color: #e0e1dd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-picker-container button:hover {
            background: rgba(0, 168, 255, 0.3);
        }

        .cloak-preset {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: rgba(224, 225, 221, 0.1);
            border: 1px solid rgba(0, 168, 255, 0.3);
            color: #e0e1dd;
            border-radius: 5px;
        }

        .cloak-preset:focus {
            outline: none;
            border-color: #00a8ff;
            box-shadow: 0 0 5px rgba(0, 168, 255, 0.5);
        }

        .custom-cloak-url {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: rgba(224, 225, 221, 0.1);
            border: 1px solid rgba(0, 168, 255, 0.3);
            color: #e0e1dd;
            border-radius: 5px;
            display: none;
        }
body.dark-mode .fps-display {
    background: rgba(26, 95, 180, 0.2);
    color: #d6dcff;
}

body.dark-mode #fps-value {
    color: #8ab4f8;
}
        .apply-cloak-btn {
            padding: 8px 15px;
            background: linear-gradient(90deg, #00a8ff, #ff2d75);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s ease;
        }

        .apply-cloak-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
        }
    </style>
    
    <!-- Non-critical CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rubik:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
    <!-- Deferred scripts -->
    <script>
        // Redirect logic
        if (window.location.hostname === 'murasakiwastaken.github.io') {
            window.location.href = 'https://murasakiwastaken.vercel.app';
        }
        
        // Load non-critical resources after page load
        function loadDeferredResources() {
            const resources = [
                'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js',
                'https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js',
                'https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js',
                'https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js',
                'https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js',
                'https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js'
            ];
            
            resources.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                document.body.appendChild(script);
            });
        }
        
        // Start loading deferred resources after DOM is parsed
        document.addEventListener('DOMContentLoaded', loadDeferredResources);
    </script>
</head>
<body>
<!-- Add this right after opening <body> tag -->
<div id="fps-counter" style="display: none;">
    FPS: <span id="fps-value">0</span>
</div>
    <!-- Auth Page (shown by default) -->
    <div class="auth-page" id="auth-page">
        <div class="auth-container">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="auth-title">Login to Your Account</h2>
                <input type="text" id="username" class="auth-input" placeholder="Username" required>
                <input type="password" id="password" class="auth-input" placeholder="Password" required>
                <button id="login-btn" class="auth-btn">Log In</button>
                <div id="auth-status" class="auth-status"></div>
                <p style="text-align: center; color: #e0e1dd;">
                    Don't have an account? <a href="#" id="show-signup" style="color: #00a8ff;">Sign Up</a>
                </p>
            </div>
            
            <!-- Signup Form (hidden by default) -->
            <div id="signup-form" class="hidden">
                <h2 class="auth-title">Create New Account</h2>
                <input type="text" id="new-username" class="auth-input" placeholder="Choose a username" required>
                <input type="password" id="new-password" class="auth-input" placeholder="Create password (min 6 chars)" required>
                <button id="signup-btn" class="auth-btn">Sign Up</button>
                <div id="signup-status" class="auth-status"></div>
                <p style="text-align: center; color: #e0e1dd;">
                    Already have an account? <a href="#" id="show-login" style="color: #00a8ff;">Log In</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Content (hidden until auth) -->
    <div class="bg-animation"></div>
    <div class="particles-container" id="particles-js"></div>
    <div class="main-container" id="main-container">
        <header class="header">
            <h1 class="title">murasaki's center v3 | enhanced experience</h1>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-category="all">All Games</div>
            <div class="tab" data-category="arcade">Arcade</div>
            <div class="tab" data-category="sports">Sports</div>
            <div class="tab" data-category="retro">Retro</div>
            <div class="tab" data-category="action">Action</div>
            <div class="tab" data-category="chatroom">Chatroom</div>
            <div class="tab" data-category="ai-assistant">AI Assistant [NEW!]</div>
        </div>
        
        <div class="game-grid">
            <!-- Game cards remain the same as your original -->
            <!-- Slope Game -->
            <div class="game-card" data-category="arcade">
                <img src="https://watchdocumentaries.com/wp-content/uploads/slope-game.jpg" alt="Slope" loading="lazy">
                <div class="game-info">
                    <h3>Slope</h3>
                    <p>Navigate a 3D course at high speed!</p>
                    <a href="#" class="play-btn" data-game="https://slope-game.github.io/rungame/slope/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Cookie Clicker -->
            <div class="game-card" data-category="arcade">
                <img src="https://www.thumbculture.co.uk/wp-content/uploads/2021/08/Cookies-1024x597.png" alt="Cookie Clicker" loading="lazy">
                <div class="game-info">
                    <h3>Cookie Clicker</h3>
                    <p>Click the cookie to earn points!</p>
                    <a href="#" class="play-btn" data-game="https://cyrillbrito.github.io/cookieclicker/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Basketball Stars -->
            <div class="game-card" data-category="sports">
                <img src="https://static.keygames.com/5/93515/96655/1200x630/basketball-stars.webp" alt="Basketball Stars" loading="lazy">
                <div class="game-info">
                    <h3>Basketball Stars</h3>
                    <p>1v1 street basketball showdowns!</p>
                    <a href="#" class="play-btn" data-game="https://basketballstarsonline.github.io/file/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Basketball Random -->
            <div class="game-card" data-category="sports">
                <img src="https://images.crazygames.com/basket-random_16x9/20240617090207/basket-random_16x9-cover?auto=format,compress&q=75&cs=strip" alt="Basketball Random" loading="lazy">
                <div class="game-info">
                    <h3>Basketball Random</h3>
                    <p>Chaotic multiplayer basketball!</p>
                    <a href="#" class="play-btn" data-game="https://basketball-random.github.io/file/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Penalty Shooters 2 -->
            <div class="game-card" data-category="sports">
                <img src="https://cdn6.aptoide.com/imgs/8/9/e/89e683612d0604ef467252311c614782_screen.jpg?w=324" alt="Penalty Shooters 2" loading="lazy">
                <div class="game-info">
                    <h3>Penalty Shooters 2</h3>
                    <p>Test your penalty shooting skills!</p>
                    <a href="#" class="play-btn" data-game="//html5.gamedistribution.com/rvvASMiM/571b9df027e449f78e3869ba19658754/index.html">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Volley Random -->
            <div class="game-card" data-category="sports">
                <img src="https://images.crazygames.com/volley-random/20230131173658/volley-random-cover?auto=format,compress&q=75&cs=strip" alt="Volley Random" loading="lazy">
                <div class="game-info">
                    <h3>Volley Random</h3>
                    <p>Crazy physics volleyball!</p>
                    <a href="#" class="play-btn" data-game="https://bolaa1.github.io/file/">PLAY NOW</a>
                </div>
            </div>
                  
            <!-- Soccer Random -->
            <div class="game-card" data-category="sports">
                <img src="https://images.crazygames.com/games/soccer-random/cover_16x9-1732744645362.png?auto=format,compress&q=75&cs=strip" alt="Soccer Random" loading="lazy">
                <div class="game-info">
                    <h3>Soccer Random</h3>
                    <p>Fast paced ball kicking (kick my balls preferably too)!</p>
                    <a href="#" class="play-btn" data-game="https://slope-game.github.io/new3723/soccer-random/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Pac-Man -->
            <div class="game-card" data-category="retro">
                <img src="https://muralsyourway.vtexassets.com/arquivos/ids/274926/Pacman-Game-Wall-Mural.jpg?v=638229015907170000" alt="Pac-Man" loading="lazy">
                <div class="game-info">
                    <h3>Pac-Man</h3>
                    <p>Classic arcade maze chase!</p>
                    <a href="#" class="play-btn" data-game="https://www.google.com/logos/2010/pacman10-i.html">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Minecraft Classic -->
            <div class="game-card" data-category="action">
                <img src="https://img.gamepix.com/games/eaglercraft/cover/eaglercraft.png?w=400&ar=16:10" alt="Minecraft Classic" loading="lazy">
                <div class="game-info">
                    <h3>Minecraft Classic</h3>
                    <p>Browser-based block building!</p>
                    <a href="#" class="play-btn" data-game="https://eaglauncher.vercel.app">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Cluster Rush -->
            <div class="game-card" data-category="action">
                <img src="https://static.hahagames.com/media/2024/05/01/012c0e6b-0438-4b67-a852-029d4082928c.jpg" alt="Cluster Rush" loading="lazy">
                <div class="game-info">
                    <h3>Cluster Rush</h3>
                    <p>Jump on and off speeding trucks!</p>
                    <a href="#" class="play-btn" data-game="https://htmlxm.github.io/h8/cluster-rush/">PLAY NOW</a>
                </div>
            </div>
        </div>
        
        <!-- Chatroom -->
        <div class="chat-container" id="chatroom">
            <div class="chat-header">
                <h2>Community Chat</h2>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="message-input" placeholder="Type your message...">
                <button class="send-btn" id="send-btn">Send</button>
            </div>
        </div>

        <!-- AI Assistant Container -->
        <div class="ai-container" id="ai-assistant">
            <div class="ai-header">
                <h2>murasaki's AI Assistant</h2>
                <p>Ask me anything about our services or get help!</p>
            </div>
            <div class="ai-conversation" id="ai-messages"></div>
        <div class="ai-input-area">
    <input type="text" class="ai-input" id="ai-input" placeholder="Type your question...">
    <button id="ai-clear-btn" class="media-upload-btn" style="margin-right: 1rem;">
        🗑️ Clear 
    </button>
    <button id="ai-attach-btn" class="media-upload-btn" style="margin-right: 1rem;">
        📎 Attach (redirects to different website) 
    </button>
    <button class="ai-send-btn" id="ai-send-btn">Send</button>
</div>
            <div id="ai-media-preview" class="media-preview"></div>
        </div>
        
        <!-- Username Modal -->
        <div class="username-modal" id="username-modal">
            <div class="username-modal-content">
                <h2>Choose Your Username</h2>
                <p>This name will be displayed with your messages</p>
                <input type="text" class="username-input" id="username-input" placeholder="Enter username..." maxlength="20">
                <button class="set-username-btn" id="set-username-btn">Join Chat</button>
            </div>
        </div>
        
        <!-- Game Modal -->
        <div class="modal">
            <div class="modal-content">
                <button class="close-btn">X</button>
                <iframe class="game-frame" src="" allowfullscreen></iframe>
            </div>
        </div>

        <!-- Settings Button -->
        <button id="settings-btn" class="settings-btn">
            <span>Settings</span>
            <i class="settings-icon">⚙️</i>
        </button>

        <!-- Settings Modal -->
        <div class="settings-modal" id="settings-modal">
            <div class="settings-content">
                <button class="settings-close">&times;</button>
                <h2>Settings</h2>
                
                <div class="settings-section">
                    <h3>Appearance</h3>

                    <div class="settings-option">
                        <label>
                            <input type="checkbox" id="dark-mode-toggle">
                            Dark Mode
                        </label>
                    </div>
                    
                    <div class="settings-option">
                        <h4>Background Color Scheme</h4>
                        <div class="color-picker-container">
                            <input type="color" id="bg-color-picker" value="#0d1b2a">
                            <button id="apply-bg-color">Apply</button>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
    <h3>Performance</h3>
    
    <div class="settings-option">
        <h4>FPS Counter</h4>
        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="fps-toggle">
                <span class="slider round"></span>
            </label>
            <span id="fps-status">Disabled</span>
        </div>
        <div id="fps-counter" class="fps-display" style="display: none;">
            Current FPS: <span id="fps-value">0</span>
        </div>
    </div>
</div>
                <div class="settings-section">
    <h3>Advanced Cloaking</h3>
    
    <div class="settings-option">
        <h4>About:Blank Cloaking</h4>
        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="about-blank-toggle">
                <span class="slider round"></span>
            </label>
            <span id="about-blank-status">Disabled</span>
        </div>
        <p class="setting-description">Opens site in an about:blank popup for maximum stealth</p>
    </div>
</div>
                <div class="settings-section">
                    <h3>Cloaking</h3>
                    
                 
                    
                    <div class="settings-option">
                        <h4>Cloak as Website</h4>
                        <select id="cloak-preset" class="cloak-preset">
                            <option value="">Select a website...</option>
                            <option value="https://docs.google.com">Google Docs</option>
                            <option value="https://classroom.google.com">Google Classroom</option>
                            <option value="https://kamiapp.com">Kami</option>
                            <option value="https://clever.com">Clever</option>
                            <option value="custom">Custom URL</option>
                        </select>
                        <input type="text" id="custom-cloak-url" class="custom-cloak-url" placeholder="Enter custom URL">
                        <button id="apply-cloak" class="apply-cloak-btn">Apply Cloak</button>
                    </div>
                </div>
                <div class="settings-section">
    <h3>Account</h3>
    <div class="settings-option">
        <button id="logout-btn" class="logout-btn">
            Log Out
        </button>
    </div>
</div>
            </div>
        </div>
    </div>

    <!-- Feedback System -->
    <div class="feedback-btn" id="feedback-btn">
        <span>Feedback</span>
        <i class="feedback-icon">💬</i>
    </div>

    <div class="feedback-modal" id="feedback-modal">
        <div class="feedback-modal-content">
            <div class="feedback-header">
                <h3>Community Feedback</h3>
                <button class="close-feedback">&times;</button>
            </div>
            <div class="feedback-messages" id="feedback-messages"></div>
            <div class="feedback-input-area">
                <textarea id="feedback-input" placeholder="Share your feedback..."></textarea>
                <div class="feedback-actions">
                    <button id="send-feedback">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Full CSS (non-critical) -->
    <noscript id="deferred-styles">
        <style>
            :root {
                --primary: #00a8ff;
                --secondary: #ff2d75;
                --dark: #0d1b2a;
                --light: #e0e1dd;
                --success: #4CAF50;
                --error: #f44336;
            }
            
            .bg-animation {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, 
                    #0f0c29 0%, 
                    #1a1a3a 25%, 
                    #24243e 50%, 
                    #302b63 75%, 
                    #24243e 100%);
                background-size: 400% 400%;
                animation: spaceGradient 30s ease infinite;
                z-index: -2;
                opacity: 0.9;
            }
            
            @keyframes spaceGradient {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }
            
            /* Particles container */
            .particles-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1;
                pointer-events: none;
            }
            
            /* Auth Container Styles */
            .auth-container {
                max-width: 400px;
                width: 100%;
                padding: 30px;
                background: rgba(13, 27, 42, 0.95);
                border-radius: 15px;
                border: 2px solid var(--primary);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                animation: windowsFade 0.6s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            .auth-title {
                color: var(--primary);
                text-align: center;
                margin-bottom: 25px;
                font-size: 1.8rem;
            }
            
            .auth-input {
                width: 100%;
                padding: 14px;
                margin-bottom: 20px;
                border-radius: 8px;
                border: 1px solid rgba(0, 168, 255, 0.3);
                background: rgba(224, 225, 221, 0.1);
                color: var(--light);
                font-size: 1rem;
                transition: all 0.3s ease;
            }
     
            .auth-input:focus {
                outline: none;
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
                border-color: var(--primary);
            }
            
            .auth-btn {
                width: 100%;
                padding: 14px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                margin-bottom: 15px;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            .auth-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(0, 168, 255, 0.3);
            }
            
            .auth-status {
                padding: 12px;
                border-radius: 8px;
                margin: 20px 0;
                text-align: center;
                display: none;
                animation: fadeIn 0.3s ease-out;
            }
            
            .auth-status.success {
                background: rgba(76, 175, 80, 0.1);
                color: var(--success);
                border: 1px solid var(--success);
                display: block;
            }
            
            .auth-status.error {
                background: rgba(244, 67, 54, 0.1);
                color: var(--error);
                border: 1px solid var(--error);
                display: block;
            }
            
            /* Header Styles */
            .header {
                text-align: center;
                padding: 2rem 0;
                position: relative;
                z-index: 10;
                animation: windowsFade 0.6s cubic-bezier(0.1, 0.9, 0.2, 1) both;
            }
            
            .title {
                font-family: 'Orbitron', sans-serif;
                font-size: clamp(2rem, 5vw, 3.5rem);
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
                text-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
                animation: pulse 4s infinite alternate;
                margin-bottom: 1rem;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                100% { transform: scale(1.025); }
            }
            
            /* Tabs Navigation */
            .tabs {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 1rem;
                padding: 1rem;
                margin-bottom: 2rem;
                animation: slideIn 0.5s ease-out both;
                animation-delay: 0.2s;
            }
            
            .tab {
                padding: 0.8rem 1.5rem;
                background: rgba(0, 0, 0, 0.5);
                border-radius: 50px;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
                font-weight: bold;
                border: 2px solid transparent;
                will-change: transform, box-shadow;
            }
            
            .tab:hover, .tab.active {
                background: rgba(0, 168, 255, 0.2);
                border-color: var(--primary);
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 168, 255, 0.2);
            }
            
            /* Game Grid */
            .game-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 2rem;
                padding: 1rem;
                width: 100%;
            }
            
            .game-card {
                background: rgba(13, 27, 42, 0.7);
                border-radius: 15px;
                overflow: hidden;
                transition: all 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
                border: 2px solid rgba(0, 168, 255, 0.3);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                opacity: 0;
                animation: fadeIn 0.6s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
                will-change: transform, box-shadow;
            }

            
            /* Staggered animation for game cards */
            .game-card:nth-child(1) { animation-delay: 0.1s; }
            .game-card:nth-child(2) { animation-delay: 0.2s; }
            .game-card:nth-child(3) { animation-delay: 0.3s; }
            .game-card:nth-child(4) { animation-delay: 0.4s; }
            .game-card:nth-child(5) { animation-delay: 0.5s; }
            .game-card:nth-child(6) { animation-delay: 0.6s; }
            .game-card:nth-child(7) { animation-delay: 0.7s; }
            .game-card:nth-child(8) { animation-delay: 0.8s; }
            .game-card:nth-child(9) { animation-delay: 0.9s; }
            .game-card:nth-child(10) { animation-delay: 1s; }
            
            .game-card:hover {
                transform: translateY(-10px) scale(1.02);
                box-shadow: 0 15px 30px rgba(0, 168, 255, 0.3);
                border-color: var(--primary);
            }
            
            .game-card img {
                width: 100%;
                height: 180px;
                object-fit: cover;
                transition: transform 0.3s ease;
            }
            
            .game-card:hover img {
                transform: scale(1.05);
            }
            
            .game-info {
                padding: 1rem;
            }
            
            .game-info h3 {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
                color: var(--primary);
            }
            
            .game-info p {
                color: rgba(224, 225, 221, 0.7);
                font-size: 0.9rem;
                margin-bottom: 1rem;
            }
            
            .play-btn {
                display: inline-block;
                padding: 0.5rem 1rem;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border-radius: 50px;
                text-decoration: none;
                font-weight: bold;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            .play-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
            }
            
            /* Chat and AI Containers */
            .chat-container, .ai-container {
                display: none;
                max-width: 800px;
                width: 100%;
                margin: 2rem auto;
                background: rgba(13, 27, 42, 0.8);
                border-radius: 15px;
                border: 2px solid var(--primary);
                box-shadow: 0 5px 15px rgba(0, 168, 255, 0.2);
                overflow: hidden;
                animation: windowsFade 0.5s ease-out both;
            }
            
            .chat-container.active, .ai-container.active {
                display: block;
            }
            
            .chat-header, .ai-header {
                background: rgba(0, 0, 0, 0.5);
                padding: 1rem;
                text-align: center;
                border-bottom: 2px solid var(--primary);
            }
            
            .chat-header h2, .ai-header h2 {
                color: var(--primary);
                font-family: 'Orbitron', sans-serif;
            }
            
            .chat-messages, .ai-conversation {
                height: 400px;
                overflow-y: auto;
                padding: 1rem;
                background: rgba(13, 27, 42, 0.5);
            }
            
            .message, .ai-message {
                margin-bottom: 1rem;
                padding: 0.8rem;
                background: rgba(0, 168, 255, 0.1);
                border-radius: 10px;
                border-left: 3px solid var(--primary);
                animation: fadeIn 0.3s ease-out;
            }
            
            .your-message, .ai-user-message {
                background: rgba(0, 168, 255, 0.2);
                border-left: 3px solid var(--secondary);
            }
            
            .system-message {
                background: rgba(255, 45, 117, 0.1);
                border-left: 3px solid var(--secondary);
            }
            
            .message-username {
                font-weight: bold;
                margin-right: 0.5rem;
            }
            
            .message-time {
                font-size: 0.7rem;
                color: rgba(224, 225, 221, 0.5);
            }
            
            .chat-input-area, .ai-input-area {
                display: flex;
                padding: 1rem;
                background: rgba(0, 0, 0, 0.3);
                border-top: 2px solid var(--primary);
            }
            
            .chat-input, .ai-input {
                flex-grow: 1;
                padding: 0.8rem;
                border: none;
                border-radius: 50px;
                background: rgba(224, 225, 221, 0.1);
                color: var(--light);
                margin-right: 1rem;
                transition: all 0.3s ease;
            }
            
            .chat-input:focus, .ai-input:focus {
                outline: none;
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            }
            
            .send-btn, .ai-send-btn {
                padding: 0.8rem 1.5rem;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            .send-btn:hover, .ai-send-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
            }
            
            /* AI Typing Indicator */
            .ai-typing {
                color: rgba(224, 225, 221, 0.7);
                font-style: italic;
            }
            
            .ai-typing::after {
                content: '...';
                animation: blink 1.5s infinite;
            }
            
            @keyframes blink {
                0%, 100% { opacity: 0.5; }
                50% { opacity: 1; }
            }
            
            .ai-error {
                color: #ff6b6b;
                font-style: italic;
            }
            
            /* Modals */
            .username-modal, .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 200;
                backdrop-filter: blur(5px);
            }
            
            .username-modal.active, .modal.active {
                display: flex;
                animation: windowsFade 0.3s ease-out;
            }
            
            .username-modal-content {
                background: var(--dark);
                padding: 2rem;
                border-radius: 15px;
                border: 2px solid var(--primary);
                text-align: center;
                max-width: 500px;
                width: 90%;
                animation: windowsFade 0.4s ease-out;
            }
            
            .username-input {
                width: 100%;
                padding: 1rem;
                margin: 1rem 0;
                border-radius: 50px;
                border: none;
                background: rgba(224, 225, 221, 0.1);
                color: var(--light);
                text-align: center;
                font-size: 1.2rem;
                transition: all 0.3s ease;
            }
            
            .username-input:focus {
                outline: none;
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            }
            
            .set-username-btn {
                padding: 0.8rem 2rem;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            .set-username-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
            }
            
            .modal-content {
                width: 90%;
                height: 80%;
                background: var(--dark);
                border-radius: 15px;
                border: 2px solid var(--primary);
                overflow: hidden;
                position: relative;
            }
            
            .close-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: var(--secondary);
                color: white;
                border: none;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                z-index: 101;
                transition: all 0.3s ease;
            }
            
            .close-btn:hover {
                transform: scale(1.1);
            }
            
            .game-frame {
                width: 100%;
                height: 100%;
                border: none;
            }
            
            /* Message delete button styles */
            .message {
                position: relative;
                padding-right: 30px;
            }
            
            .delete-message {
                position: absolute;
                right: 10px;
                top: 10px;
                opacity: 0;
                transition: opacity 0.2s;
                background: var(--error);
                color: white;
                border: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .message:hover .delete-message {
                opacity: 1;
            }
            
            /* Feedback System */
            .feedback-btn {
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                padding: 12px 20px;
                border-radius: 50px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 4px 15px rgba(0, 168, 255, 0.3);
                z-index: 1000;
                transition: all 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
                animation: slideIn 0.5s ease-out both;
                animation-delay: 0.5s;
            }
            
            .feedback-btn:hover {
                transform: translateY(-5px) scale(1.05);
                box-shadow: 0 8px 20px rgba(0, 168, 255, 0.4);
            }
            
            .feedback-modal {
                position: fixed;
                bottom: 90px;
                right: 30px;
                width: 350px;
                max-height: 500px;
                background: rgba(13, 27, 42, 0.95);
                border-radius: 15px;
                border: 2px solid var(--primary);
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
                z-index: 1001;
                display: none;
                flex-direction: column;
                overflow: hidden;
                transform-origin: bottom right;
                animation: windowsFade 0.3s ease-out;
            }
            
            .feedback-modal.active {
                display: flex;
            }
            
            .feedback-modal-content {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            .feedback-header {
                padding: 15px;
                background: rgba(0, 0, 0, 0.3);
                border-bottom: 2px solid var(--primary);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .feedback-header h3 {
                color: var(--primary);
                font-size: 1.1rem;
                margin: 0;
            }
            
            .close-feedback {
                background: none;
                border: none;
                color: var(--light);
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0 5px;
                transition: transform 0.2s ease;
            }
            
            .close-feedback:hover {
                transform: scale(1.2);
            }
            
            .feedback-messages {
                flex-grow: 1;
                padding: 15px;
                overflow-y: auto;
                background: rgba(13, 27, 42, 0.7);
            }
            
            .feedback-message {
                margin-bottom: 10px;
                padding: 10px;
                background: rgba(0, 168, 255, 0.1);
                border-radius: 8px;
                border-left: 3px solid var(--primary);
                animation: fadeIn 0.3s ease-out;
            }
            
            .feedback-message.user {
                background: rgba(0, 168, 255, 0.2);
                border-left: 3px solid var(--secondary);
            }
            
            .feedback-message p {
                margin: 5px 0;
                word-break: break-word;
            }
            
            .feedback-message .message-meta {
                display: flex;
                justify-content: space-between;
                font-size: 0.8rem;
                color: rgba(224, 225, 221, 0.7);
                margin-bottom: 5px;
            }
            
            .feedback-input-area {
                padding: 15px;
                background: rgba(0, 0, 0, 0.3);
                border-top: 2px solid var(--primary);
            }
            
            .feedback-input-area textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid rgba(0, 168, 255, 0.3);
                background: rgba(224, 225, 221, 0.1);
                color: var(--light);
                resize: none;
                min-height: 60px;
                margin-bottom: 10px;
                transition: all 0.3s ease;
            }
            
            .feedback-input-area textarea:focus {
                outline: none;
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            }
            
            .feedback-actions {
                display: flex;
                justify-content: flex-end;
            }
            
            #send-feedback {
                padding: 8px 20px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            #send-feedback:hover {
                transform: scale(1.05);
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            }

            /* Settings Button */
            .settings-btn {
                position: fixed;
                top: 30px;
                right: 30px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                padding: 12px 20px;
                border-radius: 50px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 4px 15px rgba(0, 168, 255, 0.3);
                z-index: 1000;
                transition: all 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
                animation: slideIn 0.5s ease-out both;
                animation-delay: 0.5s;
                border: none;
                font-family: 'Rubik', sans-serif;
                font-weight: bold;
            }
            
            .settings-btn:hover {
                transform: translateY(-5px) scale(1.05);
                box-shadow: 0 8px 20px rgba(0, 168, 255, 0.4);
            }
            
            /* Responsive Adjustments */
            @media (max-width: 768px) {
                .title {
                    font-size: 2.2rem;
                }
                
                .tabs {
                    gap: 0.5rem;
                }
                
                .tab {
                    padding: 0.6rem 1rem;
                    font-size: 0.9rem;
                }
                
                .game-grid {
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                }
                
                .feedback-modal {
                    width: 300px;
                    right: 15px;
                    bottom: 80px;
                }
                
                .chat-container, .ai-container {
                    margin: 1rem auto;
                }
                
                .chat-messages, .ai-conversation {
                    height: 300px;
                }

                .settings-btn {
                    top: 20px;
                    right: 20px;
                    padding: 10px 15px;
                }
            }
            
            @media (max-width: 480px) {
                .title {
                    font-size: 1.8rem;
                }
                
                .game-grid {
                    grid-template-columns: 1fr;
                }
                
                .feedback-modal {
                    width: 280px;
                    right: 10px;
                }
                
                .feedback-btn {
                    padding: 10px 15px;
                    right: 15px;
                    bottom: 20px;
                }
                
                .auth-container {
                    padding: 15px;
                }
                
                .chat-input-area, .ai-input-area {
                    flex-direction: column;
                    gap: 10px;
                }
                
                .chat-input, .ai-input {
                    margin-right: 0;
                    margin-bottom: 10px;
                }

                .settings-btn {
                    top: 15px;
                    right: 15px;
                    font-size: 0.9rem;
                }

                .settings-content {
                    width: 95%;
                    max-height: 85vh;
                }
            }
        </style>
    </noscript>
    
    <!-- Main JavaScript -->
   <script>
  import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getDatabase } from "firebase/database";
import { getStorage } from "firebase/storage";

const firebaseConfig = {
  apiKey: "AIzaSyBcrITBb6ZnwL8QLlBl30L580kJgJDue2k",
  authDomain: "chatroommurasaki.firebaseapp.com",
  projectId: "chatroommurasaki",
  storageBucket: "chatroommurasaki.appspot.com",
  messagingSenderId: "649572971936",
  appId: "1:649572971936:web:5d0aaf1be9f09cb428a0c5",
  measurementId: "G-1113622WQQ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);
const storage = getStorage(app);

    // Initialize particles.js
    function initParticles() {
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', {
                "particles": {
                    "number": {
                        "value": 60,
                        "density": {
                            "enable": true,
                            "value_area": 800
                        }
                    },
                    "color": {
                        "value": "#ffffff"
                    },
                    "shape": {
                        "type": "circle",
                        "stroke": {
                            "width": 0,
                            "color": "#000000"
                        }
                    },
                    "opacity": {
                        "value": 0.5,
                        "random": true,
                        "anim": {
                            "enable": true,
                            "speed": 1,
                            "opacity_min": 0.1,
                            "sync": false
                        }
                    },
                    "size": {
                        "value": 3,
                        "random": true,
                        "anim": {
                            "enable": true,
                            "speed": 2,
                            "size_min": 0.1,
                            "sync": false
                        }
                    },
                    "line_linked": {
                        "enable": true,
                        "distance": 150,
                        "color": "#4d8bf0",
                        "opacity": 0.4,
                        "width": 1
                    },
                    "move": {
                        "enable": true,
                        "speed": 1,
                        "direction": "none",
                        "random": true,
                        "straight": false,
                        "out_mode": "out",
                        "bounce": false
                    }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": {
                        "onhover": {
                            "enable": true,
                            "mode": "grab"
                        },
                        "onclick": {
                            "enable": true,
                            "mode": "push"
                        },
                        "resize": true
                    },
                    "modes": {
                        "grab": {
                            "distance": 140,
                            "line_linked": {
                                "opacity": 1
                            }
                        },
                        "push": {
                            "particles_nb": 4
                        }
                    }
                },
                "retina_detect": true
            });
        } else {
            setTimeout(initParticles, 100);
        }
    }

    let isScrolling = false;

    // Throttle scroll events
    window.addEventListener('scroll', () => {
        if (!isScrolling) {
            isScrolling = true;
            setTimeout(() => {
                isScrolling = false;
            }, 100);
        }
    });

    // Debounce resize events
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            // Handle resize operations here
        }, 200);
    });

    // Load non-critical CSS
    function loadDeferredStyles() {
        const addStylesNode = document.getElementById("deferred-styles");
        if (addStylesNode) {
            const replacement = document.createElement("div");
            replacement.innerHTML = addStylesNode.textContent;
            document.body.appendChild(replacement);
            addStylesNode.parentElement.removeChild(addStylesNode);
        }
    }

    // Enable/disable about:blank cloaking
    function enableAboutBlank() {
        localStorage.setItem("aboutBlank", "enabled");
        window.location.reload();
    }

    function disableAboutBlank() {
        localStorage.setItem("aboutBlank", "disabled");
        window.location.reload();
    }

    // Check and apply about:blank cloaking on page load
    function checkAboutBlank() {
        const blankerCheck = localStorage.getItem("aboutBlank");
        if (blankerCheck === "enabled") {
            let inFrame;
            try {
                inFrame = window !== top;
            } catch (e) {
                inFrame = true;
            }
            
            if (!inFrame && !navigator.userAgent.includes("Firefox")) {
                const popup = window.open("about:blank", "_blank");
                if (!popup || popup.closed) {
                    alert("Please allow popups and redirects for about:blank cloak to work.");
                } else {
                    const doc = popup.document;
                    const iframe = doc.createElement("iframe");
                    const style = iframe.style;
                    const link = doc.createElement("link");
                    
                    const name = localStorage.getItem("cloakTitle") || "Google Drive";
                    const icon = localStorage.getItem("cloakFavicon") || 
                        "https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png";
                    
                    doc.title = name;
                    link.rel = "icon";
                    link.href = icon;
                    iframe.src = window.location.href;
                    
                    style.position = "fixed";
                    style.top = style.bottom = style.left = style.right = "0";
                    style.border = style.outline = "none";
                    style.width = style.height = "100%";
                    
                    doc.head.appendChild(link);
                    doc.body.appendChild(iframe);
                    
                    window.location.replace("https://drive.google.com");
                }
            }
        }
    }

    function checkPopupBlocker() {
        const blankerCheck = localStorage.getItem("aboutBlank");
        if (blankerCheck === "enabled") {
            const testPopup = window.open("", "_blank");
            if (!testPopup || testPopup.closed) {
                alert("Popup blocker detected! Please allow popups for this site for about:blank cloaking to work.");
            } else {
                testPopup.close();
            }
        }
    }

    // Main application initialization
    function initApplication() {
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Set auth persistence to LOCAL
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log("Auth persistence set to LOCAL");
            })
            .catch((error) => {
                console.error("Error setting auth persistence:", error);
            });

        // DOM Elements
        const authPage = document.getElementById('auth-page');
        const mainContainer = document.getElementById('main-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const newUsernameInput = document.getElementById('new-username');
        const newPasswordInput = document.getElementById('new-password');
        const authStatus = document.getElementById('auth-status');
        const signupStatus = document.getElementById('signup-status');
        
        // Toggle between login and signup forms
        if (showSignup) {
            showSignup.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                clearStatus();
            });
        }
        
        if (showLogin) {
            showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                clearStatus();
            });
        }
        
        // Login function
        if (loginBtn) {
            loginBtn.addEventListener('click', async () => {
                if (typeof firebase === 'undefined' || !firebase.apps.length) {
                    showError(authStatus, 'Authentication system is loading. Please wait...');
                    return;
                }
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();
                
                if (!username || !password) {
                    showError(authStatus, 'Please enter both username and password');
                    return;
                }
                
                const email = `${username}@example.com`;
                
                try {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Logging in...';
                    
                    if (typeof firebase === 'undefined') {
                        throw new Error('Firebase not loaded yet');
                    }
                    
                    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    
                    showSuccess(authStatus, 'Login successful!');
                    authPage.style.display = 'none';
                    mainContainer.style.display = 'flex';
                    localStorage.setItem('lastLogin', Date.now());
                    
                    initParticles();
                    initTabSystem();
                    initFeedbackSystem();
                    initSettingsSystem();
                    
                } catch (error) {
                    console.error('Login error:', error);
                    let errorMessage = 'Login failed. Please try again.';
                    
                    if (error.code) {
                        switch (error.code) {
                            case 'auth/wrong-password':
                                errorMessage = 'Incorrect password';
                                break;
                            case 'auth/user-not-found':
                                errorMessage = 'Username not found';
                                break;
                            case 'auth/too-many-requests':
                                errorMessage = 'Too many attempts. Try again later.';
                                break;
                            case 'auth/network-request-failed':
                                errorMessage = 'Network error. Check your connection.';
                                break;
                        }
                    } else if (error.message.includes('Firebase not loaded')) {
                        errorMessage = 'System still loading. Please wait...';
                    }
                    
                    showError(authStatus, errorMessage);
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Log In';
                }
            });
        }

        // Signup function
        if (signupBtn) {
            signupBtn.addEventListener('click', () => {
                const username = newUsernameInput.value.trim();
                const password = newPasswordInput.value.trim();
                
                if (!username || !password) {
                    showError(signupStatus, 'Please enter both username and password');
                    return;
                }
                
                if (password.length < 6) {
                    showError(signupStatus, 'Password must be at least 6 characters');
                    return;
                }
                
                const email = `${username}@example.com`;
                
                signupBtn.disabled = true;
                signupBtn.textContent = 'Creating account...';
                
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => {
                        return auth.createUserWithEmailAndPassword(email, password);
                    })
                    .then((userCredential) => {
                        showSuccess(signupStatus, 'Account created successfully!');
                        authPage.style.display = 'none';
                        mainContainer.style.display = 'flex';
                        localStorage.setItem('lastLogin', Date.now());
                        initParticles();
                        initTabSystem();
                        initFeedbackSystem();
                        initSettingsSystem();
                    })
                    .catch((error) => {
                        showError(signupStatus, getErrorMessage(error));
                    })
                    .finally(() => {
                        signupBtn.disabled = false;
                        signupBtn.textContent = 'Sign Up';
                    });
            });
        }
        
        // Helper functions
        function clearInputs() {
            if (usernameInput) usernameInput.value = '';
            if (passwordInput) passwordInput.value = '';
            if (newUsernameInput) newUsernameInput.value = '';
            if (newPasswordInput) newPasswordInput.value = '';
        }
        
        function clearStatus() {
            if (authStatus) {
                authStatus.classList.remove('success', 'error');
                authStatus.style.display = 'none';
            }
            if (signupStatus) {
                signupStatus.classList.remove('success', 'error');
                signupStatus.style.display = 'none';
            }
        }
        
        function showError(element, message) {
            if (element) {
                element.textContent = message;
                element.classList.remove('success');
                element.classList.add('error');
                element.style.display = 'block';
            }
        }
        
        function showSuccess(element, message) {
            if (element) {
                element.textContent = message;
                element.classList.remove('error');
                element.classList.add('success');
                element.style.display = 'block';
            }
        }
        
        function getErrorMessage(error) {
            if (!error.code) return 'Login failed. Please try again.';
            
            switch (error.code) {
                case 'auth/wrong-password':
                    return 'Incorrect password';
                case 'auth/user-not-found':
                    return 'Username not found';
                case 'auth/email-already-in-use':
                    return 'Username already taken';
                case 'auth/weak-password':
                    return 'Password must be at least 6 characters';
                default:
                    return 'Login failed. Please try again.';
            }
        }
        
        // Setup auth state listener
        let authStateUnsubscribe = null;
        
        function setupAuthStateListener() {
            if (authStateUnsubscribe) {
                authStateUnsubscribe();
            }
            
            authStateUnsubscribe = auth.onAuthStateChanged((user) => {
                try {
                    console.log('Auth state changed:', user ? 'Logged in' : 'Logged out');
                    
                    if (user) {
                        authPage.style.display = 'none';
                        mainContainer.style.display = 'flex';
                        localStorage.setItem('lastLogin', Date.now());
                        
                        if (!window.systemsInitialized) {
                            initParticles();
                            initTabSystem();
                            initFeedbackSystem();
                            initSettingsSystem();
                            window.systemsInitialized = true;
                        }
                    } else {
                        const lastLogin = localStorage.getItem('lastLogin');
                        const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                        
                        if (lastLogin && (Date.now() - parseInt(lastLogin)) > thirtyDays) {
                            localStorage.removeItem('lastLogin');
                            localStorage.removeItem('chatUsername');
                        }
                        
                        window.systemsInitialized = false;
                    }
                } catch (error) {
                    console.error('Auth state change error:', error);
                    if (!window.lastAuthError || Date.now() - window.lastAuthError > 5000) {
                        showError(authStatus, 'Session error. Please refresh.');
                        window.lastAuthError = Date.now();
                    }
                }
            });
        }
        
        setupAuthStateListener();
        
        window.addEventListener('beforeunload', () => {
            if (authStateUnsubscribe) {
                authStateUnsubscribe();
            }
        });
    }

    // Tab System
    function initTabSystem() {
        const tabs = document.querySelectorAll('.tab');
        const gameCards = document.querySelectorAll('.game-card');
        const chatContainer = document.getElementById('chatroom');
        const aiContainer = document.getElementById('ai-assistant');
        
        function switchTab(tab) {
            if (!tab) return;
            
            const category = tab.dataset.category;
            
            const currentActiveTab = document.querySelector('.tab.active');
            if (currentActiveTab) {
                currentActiveTab.classList.remove('active');
            }
            
            tab.classList.add('active');
            
            if (chatContainer && chatContainer.classList.contains('active')) {
                chatContainer.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    chatContainer.classList.remove('active');
                    chatContainer.style.display = 'none';
                    chatContainer.style.animation = '';
                }, 300);
            }
            
            if (aiContainer && aiContainer.classList.contains('active')) {
                aiContainer.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    aiContainer.classList.remove('active');
                    aiContainer.style.display = 'none';
                    aiContainer.style.animation = '';
                }, 300);
            }
            
            if (gameCards) {
                gameCards.forEach(card => {
                    if (card.style.display === 'block') {
                        card.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            card.style.display = 'none';
                            card.style.animation = '';
                        }, 300);
                    }
                });
            }
            
            setTimeout(() => {
                if (category === 'chatroom' && chatContainer) {
                    chatContainer.style.display = 'block';
                    setTimeout(() => {
                        chatContainer.classList.add('active');
                        chatContainer.style.animation = 'fadeIn 0.3s ease-out forwards';
                        checkUsername();
                    }, 10);
                } else if (category === 'ai-assistant' && aiContainer) {
                    aiContainer.style.display = 'block';
                    setTimeout(() => {
                        aiContainer.classList.add('active');
                        aiContainer.style.animation = 'fadeIn 0.3s ease-out forwards';
                        if (document.getElementById('ai-messages') && document.getElementById('ai-messages').children.length === 0) {
                            addAIMessage("Hello! I'm murasaki's AI assistant. How can I help you today?");
                            addAIMessage("For image analysis, this AI is currently unsupported, please use the attach button below to redirect yourself to another website. Thank you for your understanding.", false);
                        }
                    }, 10);
                } else if (gameCards) {
                    gameCards.forEach(card => {
                        if (category === 'all' || card.dataset.category === category) {
                            card.style.display = 'none';
                            setTimeout(() => {
                                card.style.display = 'block';
                                card.style.animation = 'fadeIn 0.3s ease-out forwards';
                            }, 10);
                        }
                    });
                }
            }, 300);
        }
        
        if (tabs) {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab);
                });
            });
        }
        
        const initialTab = document.querySelector('.tab.active');
        if (initialTab) {
            switchTab(initialTab);
        }
        
        // Game modal
        const modal = document.querySelector('.modal');
        const playBtns = document.querySelectorAll('.play-btn');
        const closeBtn = document.querySelector('.close-btn');
        const gameFrame = document.querySelector('.game-frame');

        if (playBtns) {
            playBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const gameUrl = btn.dataset.game;
                    if (!gameUrl) {
                        console.error('No game URL specified');
                        return;
                    }
                    
                    gameFrame.src = '';
                    if (modal) modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    setTimeout(() => {
                        if (gameFrame) gameFrame.src = gameUrl;
                    }, 300);
                });
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
                closeGameModal();
            }
        });

        function closeGameModal() {
            if (modal) modal.classList.remove('active');
            if (gameFrame) gameFrame.src = '';
            document.body.style.overflow = 'auto';
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', closeGameModal);
        }

        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeGameModal();
                }
            });
        }
    }

    // Chat System
    function checkUsername() {
        const usernameModal = document.getElementById('username-modal');
        const chatUsername = localStorage.getItem('chatUsername') || '';
        
        if (usernameModal) {
            if (!chatUsername) {
                usernameModal.classList.add('active');
                const chatUsernameInput = document.getElementById('username-input');
                if (chatUsernameInput) chatUsernameInput.focus();
            } else {
                usernameModal.classList.remove('active');
                loadChatHistory();
            }
        }
    }

    function setUsername() {
        const chatUsernameInput = document.getElementById('username-input');
        const usernameModal = document.getElementById('username-modal');
        const newUsername = chatUsernameInput ? chatUsernameInput.value.trim() : '';
        
        if (newUsername) {
            localStorage.setItem('chatUsername', newUsername);
            if (usernameModal) usernameModal.classList.remove('active');
            
            const chatRef = firebase.database().ref('chat');
            chatRef.push({
                username: 'System',
                message: `${newUsername} joined the chat!`,
                timestamp: Date.now()
            });
            
            loadChatHistory();
        }
    }

    function loadChatHistory() {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;
        
        const chatRef = firebase.database().ref('chat');
        chatRef.limitToLast(100).on('value', (snapshot) => {
            if (snapshot.numChildren() > chatMessages.children.length) {
                chatMessages.innerHTML = '';
            }
            
            snapshot.forEach((childSnapshot) => {
                const msg = childSnapshot.val();
                if (!document.querySelector(`[data-key="${childSnapshot.key}"]`)) {
                    displayMessage({
                        ...msg,
                        key: childSnapshot.key
                    });
                }
            });
            
            scrollToBottom();
        });
    }

    function displayMessage({ username, message, timestamp, key, isSystem }) {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;
        
        const chatUsername = localStorage.getItem('chatUsername') || '';
        const isCurrentUser = username === chatUsername;
        const isSystemMsg = username === 'System' || username === 'AI Assistant' || isSystem;
        
        const messageEl = document.createElement('div');
        messageEl.className = `message ${isCurrentUser ? 'your-message' : ''} ${isSystemMsg ? 'system-message' : ''}`;
        
        const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        let deleteBtn = '';
        if (isCurrentUser && !isSystemMsg) {
            deleteBtn = `<button class="delete-message" data-key="${key}">×</button>`;
        }
        messageEl.setAttribute('data-key', key);

        messageEl.innerHTML = `
            ${deleteBtn}
            <span class="message-username" style="color: ${isSystemMsg ? '#ff2d75' : '#00a8ff'}">${username}:</span>
            <span class="message-text">${message}</span>
            <div class="message-time">${time}</div>
        `;
        
        chatMessages.appendChild(messageEl);
        scrollToBottom();
        
        if (isCurrentUser && !isSystemMsg) {
            const deleteBtnEl = messageEl.querySelector('.delete-message');
            if (deleteBtnEl) {
                deleteBtnEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const messageKey = e.target.getAttribute('data-key');
                    deleteMessage(messageKey);
                });
            }
        }
    }

    function deleteMessage(messageKey) {
        if (confirm('Are you sure you want to delete this message?')) {
            firebase.database().ref('chat/' + messageKey).remove()
                .then(() => {
                    console.log('Message deleted successfully');
                })
                .catch((error) => {
                    console.error('Error deleting message:', error);
                });
        }
    }

    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput ? messageInput.value.trim() : '';
        const chatUsername = localStorage.getItem('chatUsername') || '';
        
        if (message && chatUsername) {
            firebase.database().ref('chat').push({
                username: chatUsername,
                message,
                timestamp: Date.now()
            });
            if (messageInput) messageInput.value = '';
        }
    }

    // Initialize chat event listeners
    const setUsernameBtn = document.getElementById('set-username-btn');
    const chatUsernameInput = document.getElementById('username-input');
    const sendBtn = document.getElementById('send-btn');
    const messageInput = document.getElementById('message-input');

    if (setUsernameBtn) {
        setUsernameBtn.addEventListener('click', setUsername);
    }
    
    if (chatUsernameInput) {
        chatUsernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') setUsername();
        });
    }
    
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    if (messageInput) {
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                const message = messageInput.value.trim();
                const chatUsername = localStorage.getItem('chatUsername') || '';
                if (message && chatUsername) {
                    firebase.database().ref('chat').push({
                        username: chatUsername,
                        message,
                        timestamp: Date.now()
                    });
                    messageInput.value = '';
                }
            }
        });
    }

    // AI Assistant
    let conversationHistory = [];

    function addAIMessage(text, isUser = false) {
        const aiMessages = document.getElementById('ai-messages');
        if (!aiMessages) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${isUser ? 'ai-user-message' : ''}`;
        messageDiv.style.animation = 'fadeIn 0.3s ease-out';
        messageDiv.innerHTML = `<div class="message-text">${text}</div>`;
        aiMessages.appendChild(messageDiv);
        aiMessages.scrollTop = aiMessages.scrollHeight;
        
        conversationHistory.push({
            role: isUser ? 'user' : 'assistant',
            content: text
        });
        
        if (conversationHistory.length > 50) {
            conversationHistory = conversationHistory.slice(-50);
        }
    }

    function showTypingIndicator() {
        const aiMessages = document.getElementById('ai-messages');
        if (!aiMessages) return null;
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-message ai-typing';
        typingDiv.textContent = 'AI is thinking...';
        typingDiv.id = 'typing-indicator';
        typingDiv.style.animation = 'fadeIn 0.3s ease-out';
        aiMessages.appendChild(typingDiv);
        aiMessages.scrollTop = aiMessages.scrollHeight;
        return typingDiv;
    }

    function removeTypingIndicator() {
        const typingDiv = document.getElementById('typing-indicator');
        if (typingDiv) {
            typingDiv.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => typingDiv.remove(), 300);
        }
    }

    async function getAIResponse(question) {
        try {
            const response = await fetch('https://murasakiwastaken.vercel.app/api/ai-proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    messages: [
                        {
                            role: "system",
                            content: "You are murasaki's helpful AI assistant. Be concise and helpful."
                        },
                        ...conversationHistory,
                        {
                            role: "user",
                            content: question
                        }
                    ]
                })
            });
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.response || "I didn't get a response.";
        } catch (error) {
            console.error('AI Error:', error);
            return `Error: ${error.message}`;
        }
    }

    function clearConversation() {
        conversationHistory = [];
        const aiMessages = document.getElementById('ai-messages');
        if (aiMessages) aiMessages.innerHTML = '';
        addAIMessage("Hello! I'm murasaki's AI assistant. How can I help you today?");
        addAIMessage("For image analysis, this AI is currently unsupported, please use the attach button below to redirect yourself to another website. Thank you for your understanding.", false);
    }

    async function handleAIInput() {
        const aiInput = document.getElementById('ai-input');
        const question = aiInput ? aiInput.value.trim() : '';
        if (!question) return;
        
        addAIMessage(question, true);
        
        if (aiInput) aiInput.value = '';
        const typingDiv = showTypingIndicator();
        
        try {
            const response = await getAIResponse(question);
            removeTypingIndicator();
            addAIMessage(response);
        } catch (error) {
            removeTypingIndicator();
            addAIMessage("Sorry, I couldn't process your request. Please try again.");
        }
    }

    // Initialize AI event listeners
    const aiSendBtn = document.getElementById('ai-send-btn');
    const aiInput = document.getElementById('ai-input');
    const aiAttachBtn = document.getElementById('ai-attach-btn');
    const aiClearBtn = document.getElementById('ai-clear-btn');

    if (aiSendBtn) {
        aiSendBtn.addEventListener('click', handleAIInput);
    }
    
    if (aiInput) {
        aiInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAIInput();
        });
    }
    
    if (aiAttachBtn) {
        aiAttachBtn.addEventListener('click', () => {
            if (confirm("Image analysis requires visiting an external site. Proceed?")) {
                window.location.href = "https://aiassistantbot.pages.dev";
            }
        });
    }
    
    if (aiClearBtn) {
        aiClearBtn.addEventListener('click', clearConversation);
    }

    // Feedback System
    function initFeedbackSystem() {
        const feedbackBtn = document.getElementById('feedback-btn');
        const feedbackModal = document.getElementById('feedback-modal');
        const closeFeedback = document.querySelector('.close-feedback');
        const feedbackInput = document.getElementById('feedback-input');
        const sendFeedbackBtn = document.getElementById('send-feedback');
        const feedbackMessages = document.getElementById('feedback-messages');
        
        if (!feedbackBtn || !feedbackModal) return;
        
        const feedbackRef = firebase.database().ref('feedback');
        const auth = firebase.auth();
        let feedbackUsername = auth.currentUser ? auth.currentUser.email.split('@')[0] : 'Anonymous';

        function loadFeedbackMessages() {
            feedbackRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                if (feedbackMessages) feedbackMessages.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const msg = childSnapshot.val();
                    displayFeedbackMessage({
                        ...msg,
                        key: childSnapshot.key
                    });
                });
                
                scrollFeedbackToBottom();
            });
        }

        function displayFeedbackMessage({ username, message, timestamp, key }) {
            if (!feedbackMessages) return;
            
            const messageEl = document.createElement('div');
            messageEl.className = 'feedback-message';
            messageEl.style.animation = 'fadeIn 0.3s ease-out';
            
            const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageEl.innerHTML = `
                <div class="message-meta">
                    <span class="message-username">${username}:</span>
                    <span class="message-time">${time}</span>
                </div>
                <p class="message-text">${message}</p>
            `;
            
            feedbackMessages.appendChild(messageEl);
        }

        function sendFeedback() {
            const message = feedbackInput ? feedbackInput.value.trim() : '';
            if (!message) return;
            
            const feedbackData = {
                username: feedbackUsername,
                message: message,
                timestamp: Date.now()
            };
            
            feedbackRef.push(feedbackData)
                .then(() => {
                    if (feedbackInput) feedbackInput.value = '';
                    scrollFeedbackToBottom();
                })
                .catch(error => {
                    console.error("Error sending feedback:", error);
                    alert("Failed to send feedback. Please try again.");
                });
        }

        function scrollFeedbackToBottom() {
            if (feedbackMessages) {
                feedbackMessages.scrollTop = feedbackMessages.scrollHeight;
            }
        }

        feedbackBtn.addEventListener('click', () => {
            feedbackModal.classList.toggle('active');
            if (feedbackModal.classList.contains('active')) {
                loadFeedbackMessages();
            }
        });

        if (closeFeedback) {
            closeFeedback.addEventListener('click', () => {
                if (feedbackModal) feedbackModal.classList.remove('active');
            });
        }

        if (sendFeedbackBtn) {
            sendFeedbackBtn.addEventListener('click', sendFeedback);
        }
        
        if (feedbackInput) {
            feedbackInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    sendFeedback();
                }
            });
        }
    }

    // Settings System
    function initSettingsSystem() {
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.querySelector('.settings-close');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const applyBgColorBtn = document.getElementById('apply-bg-color');
        const cloakPreset = document.getElementById('cloak-preset');
        const customCloakUrl = document.getElementById('custom-cloak-url');
        const applyCloakBtn = document.getElementById('apply-cloak');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutConfirmModal = document.getElementById('logout-confirm-modal');
        const confirmLogoutBtn = document.getElementById('confirm-logout');
        const cancelLogoutBtn = document.getElementById('cancel-logout');
        const aboutBlankToggle = document.getElementById('about-blank-toggle');
        const aboutBlankStatus = document.getElementById('about-blank-status');
        const fpsToggle = document.getElementById('fps-toggle');
        const fpsStatus = document.getElementById('fps-status');
        const fpsCounter = document.getElementById('fps-counter');
        const fpsValue = document.getElementById('fps-value');

        // FPS Counter
        let fpsLastTime = performance.now();
        let fpsFrames = 0;
        let fps = 0;
        let fpsInterval;
        let fpsEnabled = localStorage.getItem('fpsEnabled') === 'true';

        if (fpsToggle) {
            fpsToggle.checked = fpsEnabled;
            if (fpsStatus) fpsStatus.textContent = fpsEnabled ? 'Enabled' : 'Disabled';
            if (fpsEnabled) {
                startFPSCounter();
            }
        }

        function startFPSCounter() {
            if (fpsCounter) fpsCounter.style.display = 'block';
            fpsInterval = setInterval(updateFPSCounter, 1000);
            requestAnimationFrame(countFPSFrame);
        }

        function stopFPSCounter() {
            if (fpsCounter) fpsCounter.style.display = 'none';
            clearInterval(fpsInterval);
            if (fpsValue) fpsValue.textContent = '0';
        }

        function countFPSFrame() {
            fpsFrames++;
            const now = performance.now();
            if (now >= fpsLastTime + 1000) {
                fps = Math.round((fpsFrames * 1000) / (now - fpsLastTime));
                fpsLastTime = now;
                fpsFrames = 0;
            }
            if (fpsEnabled) {
                requestAnimationFrame(countFPSFrame);
            }
        }

        function updateFPSCounter() {
            if (fpsValue) fpsValue.textContent = fps;
        }

        if (fpsToggle) {
            fpsToggle.addEventListener('change', function() {
                fpsEnabled = this.checked;
                if (fpsStatus) fpsStatus.textContent = fpsEnabled ? 'Enabled' : 'Disabled';
                localStorage.setItem('fpsEnabled', fpsEnabled);
                
                if (fpsEnabled) {
                    startFPSCounter();
                } else {
                    stopFPSCounter();
                }
            });
        }

        // About Blank
        if (aboutBlankToggle) {
            const aboutBlankState = localStorage.getItem("aboutBlank") === "enabled";
            aboutBlankToggle.checked = aboutBlankState;
            if (aboutBlankStatus) aboutBlankStatus.textContent = aboutBlankState ? "Enabled" : "Disabled";

            aboutBlankToggle.addEventListener('change', function() {
                if (this.checked) {
                    enableAboutBlank();
                } else {
                    disableAboutBlank();
                }
            });
        }

        // Logout
        if (logoutBtn && logoutConfirmModal && confirmLogoutBtn && cancelLogoutBtn) {
            logoutBtn.addEventListener('click', () => {
                logoutConfirmModal.style.display = 'flex';
            });

            cancelLogoutBtn.addEventListener('click', () => {
                logoutConfirmModal.style.display = 'none';
            });

            confirmLogoutBtn.addEventListener('click', () => {
                firebase.auth().signOut().then(() => {
                    localStorage.removeItem('chatUsername');
                    localStorage.removeItem('lastLogin');
                    
                    logoutConfirmModal.style.display = 'none';
                    if (settingsModal) settingsModal.classList.remove('active');
                    
                    const authPage = document.getElementById('auth-page');
                    const mainContainer = document.getElementById('main-container');
                    if (authPage) authPage.style.display = 'flex';
                    if (mainContainer) mainContainer.style.display = 'none';
                    
                    resetCloak();
                }).catch((error) => {
                    console.error("Logout error:", error);
                    alert("Error during logout. Please try again.");
                });
            });
        }

        // Cloaking
        function handleCloakPresetChange() {
            if (customCloakUrl) {
                customCloakUrl.style.display = this.value === 'custom' ? 'block' : 'none';
            }
        }

        function applyCloak() {
            const { targetUrl, title, faviconUrl } = getCloakSettings();
            if (!targetUrl) return;
            
            activateIframeCloak(targetUrl, title, faviconUrl);
            saveCloakSettings(targetUrl, title, faviconUrl);
        }

        function getCloakSettings() {
            if (!cloakPreset) return {};
            
            let targetUrl, title, faviconUrl;

            switch (cloakPreset.value) {
                case 'https://docs.google.com':
                    return {
                        targetUrl: 'https://docs.google.com',
                        title: 'Google Docs',
                        faviconUrl: 'https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png'
                    };
                case 'https://classroom.google.com':
                    return {
                        targetUrl: 'https://classroom.google.com',
                        title: 'Google Classroom',
                        faviconUrl: 'https://ssl.gstatic.com/classroom/favicon.png'
                    };
                case 'https://kamiapp.com':
                    return {
                        targetUrl: 'https://kamiapp.com',
                        title: 'Kami',
                        faviconUrl: 'https://kamiapp.com/favicon.ico'
                    };
                case 'https://clever.com':
                    return {
                        targetUrl: 'https://clever.com',
                        title: 'Clever',
                        faviconUrl: 'https://clever.com/favicon.ico'
                    };
                case 'custom':
                    targetUrl = customCloakUrl ? customCloakUrl.value.trim() : '';
                    if (!targetUrl) {
                        alert('Please enter a valid URL');
                        return {};
                    }
                    return {
                        targetUrl,
                        title: prompt('Enter tab title:') || 'My Tab',
                        faviconUrl: prompt('Enter favicon URL (optional):') || ''
                    };
                default:
                    alert('Please select a preset or enter a custom URL!');
                    return {};
            }
        }

        function activateIframeCloak(url, title, faviconUrl) {
            document.querySelectorAll('.main-container > *').forEach(el => {
                if (!el.classList.contains('settings-modal') && 
                    el.id !== 'cloak-toggle-btn') {
                    el.style.display = 'none';
                }
            });
            
            const feedbackBtn = document.getElementById('feedback-btn');
            if (feedbackBtn) feedbackBtn.style.display = 'none';
            
            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn) settingsBtn.style.display = 'none';

            let iframe = document.getElementById('cloak-iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'cloak-iframe';
                iframe.style.position = 'fixed';
                iframe.style.top = '0';
                iframe.style.left = '0';
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.zIndex = '9990';
                document.body.appendChild(iframe);
            }
            iframe.src = url;

            const toggleBtn = document.getElementById('cloak-toggle-btn') || createToggleButton();
            setupToggleBehavior(iframe, toggleBtn);

            updateTabAppearance(title, faviconUrl);
        }

        function createToggleButton() {
            const btn = document.createElement('button');
            btn.id = 'cloak-toggle-btn';
            btn.className = 'cloak-toggle-btn';
            btn.textContent = '👁️';
            document.body.appendChild(btn);
            return btn;
        }

        function setupToggleBehavior(iframe, btn) {
            let cloakActive = true;
            btn.addEventListener('click', () => {
                cloakActive = !cloakActive;
                if (iframe) iframe.style.display = cloakActive ? 'block' : 'none';
                btn.textContent = cloakActive ? '👁️' : '👁️‍🗨️';
                
                if (!cloakActive) {
                    document.querySelectorAll('.main-container > *').forEach(el => {
                        el.style.display = '';
                    });
                    
                    const feedbackBtn = document.getElementById('feedback-btn');
                    if (feedbackBtn) feedbackBtn.style.display = '';
                    
                    const settingsBtn = document.getElementById('settings-btn');
                    if (settingsBtn) settingsBtn.style.display = '';
                } else {
                    document.querySelectorAll('.main-container > *').forEach(el => {
                        if (!el.classList.contains('settings-modal') && 
                            el.id !== 'cloak-toggle-btn') {
                            el.style.display = 'none';
                        }
                    });
                    const feedbackBtn = document.getElementById('feedback-btn');
                    if (feedbackBtn) feedbackBtn.style.display = 'none';
                    const settingsBtn = document.getElementById('settings-btn');
                    if (settingsBtn) settingsBtn.style.display = 'none';
                }
            });
        }

        function updateTabAppearance(title, faviconUrl) {
            document.title = title || document.title;
            updateFavicon(faviconUrl);
        }

        function updateFavicon(url) {
            if (!url) return;
            
            let favicon = document.querySelector('link[rel="icon"]') || 
                         document.createElement('link');
            favicon.rel = 'icon';
            favicon.href = url;
            document.head.appendChild(favicon);
        }

        function saveCloakSettings(url, title, faviconUrl) {
            localStorage.setItem('cloakActive', 'true');
            localStorage.setItem('cloakUrl', url);
            localStorage.setItem('cloakTitle', title);
            localStorage.setItem('cloakFavicon', faviconUrl);
            if (cloakPreset) localStorage.setItem('cloakPreset', cloakPreset.value);
        }

        // Appearance
        function toggleDarkMode(e) {
            const enabled = e.target.checked;
            
            document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            document.body.classList.toggle('dark-mode', enabled);
            localStorage.setItem('darkMode', enabled);
            
            setTimeout(() => {
                document.body.style.transition = '';
            }, 300);
        }

        function applyBackgroundColor() {
            const color = bgColorPicker ? bgColorPicker.value : '#0d1b2a';
            document.body.style.backgroundColor = color;
            localStorage.setItem('bgColor', color);
        }

        // Load settings
        function loadSettings() {
            // Dark Mode
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkModeToggle) darkModeToggle.checked = darkMode;
            document.body.classList.toggle('dark-mode', darkMode);

            // Background Color
            const bgColor = localStorage.getItem('bgColor') || '#0d1b2a';
            if (bgColorPicker) bgColorPicker.value = bgColor;
            document.body.style.backgroundColor = bgColor;

            // Cloaking
            const cloakPresetValue = localStorage.getItem('cloakPreset') || '';
            if (cloakPreset) cloakPreset.value = cloakPresetValue;
            if (customCloakUrl) {
                customCloakUrl.style.display = cloakPresetValue === 'custom' ? 'block' : 'none';
                customCloakUrl.value = localStorage.getItem('customCloakUrl') || '';
            }

            if (localStorage.getItem('cloakActive') === 'true') {
                const url = localStorage.getItem('cloakUrl');
                const title = localStorage.getItem('cloakTitle');
                const favicon = localStorage.getItem('cloakFavicon');
                if (url && title) activateIframeCloak(url, title, favicon);
            }
        }

        // Event listeners
        if (settingsBtn && settingsModal) {
            settingsBtn.addEventListener('click', () => settingsModal.classList.toggle('active'));
        }
        
        if (closeSettings && settingsModal) {
            closeSettings.addEventListener('click', () => settingsModal.classList.remove('active'));
        }
        
        if (cloakPreset) {
            cloakPreset.addEventListener('change', handleCloakPresetChange);
        }
        
        if (applyCloakBtn) {
            applyCloakBtn.addEventListener('click', applyCloak);
        }
        
        if (darkModeToggle) {
            darkModeToggle.addEventListener('change', toggleDarkMode);
        }
        
        if (applyBgColorBtn && bgColorPicker) {
            applyBgColorBtn.addEventListener('click', applyBackgroundColor);
        }

        loadSettings();
    }

    function resetCloak() {
        const iframe = document.getElementById('cloak-iframe');
        const toggleBtn = document.getElementById('cloak-toggle-btn');
        if (iframe) iframe.remove();
        if (toggleBtn) toggleBtn.remove();
        
        document.querySelectorAll('.main-container > *').forEach(el => {
            el.style.display = '';
        });
        
        const feedbackBtn = document.getElementById('feedback-btn');
        if (feedbackBtn) feedbackBtn.style.display = '';
        
        const settingsBtn = document.getElementById('settings-btn');
        if (settingsBtn) settingsBtn.style.display = '';
        
        localStorage.removeItem('cloakActive');
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Loaded successfully!');
        initializeFirebase();
        checkAboutBlank();
        
        // Check for system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) darkModeToggle.checked = true;
        }
        
        // Check popup blocker when settings button is clicked
        const settingsBtn = document.getElementById('settings-btn');
        if (settingsBtn) {
            settingsBtn.addEventListener('click', checkPopupBlocker);
        }
    });
</script>
    <div class="logout-confirm-modal" id="logout-confirm-modal">
    <div class="logout-confirm-content">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to log out?</p>
        <div class="logout-confirm-buttons">
            <button class="confirm-btn" id="confirm-logout">Log Out</button>
            <button class="cancel-btn" id="cancel-logout">Cancel</button>
        </div>
    </div>
</div>
</body>
</html>
